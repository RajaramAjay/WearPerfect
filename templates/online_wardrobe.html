<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WearPerfect - Smart Fashion Recommender</title>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #f472b6;
      --success: #10b981;
      --danger: #ef4444;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9fafb;
      color: #1f2937;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    } 
    header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
    }
    header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: bold;
    }
    header p {
      margin: 4px 0 0;
      font-size: 1rem;
      opacity: 0.9;
    }
    .upload-section {
      background-color: #f3f4f6;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 30px;
    }
    .upload-button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .upload-button:hover {
      background-color: var(--primary-dark);
    }
    .upload-type-btn {
      background-color: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 8px 15px;
      margin: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .upload-type-btn.active {
      border-color: var(--primary);
      color: var(--primary);
    }
    .sub-tabs {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    .sub-tab-button {
      padding: 10px 20px;
      background-color: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      margin: 0 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .sub-tab-button.active {
      border-color: var(--primary);
      color: var(--primary);
      background-color: rgba(99, 102, 241, 0.1);
    }
    .wardrobe-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .clothes-item {
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
      transition: transform 0.3s ease;
    }
    .clothes-item img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .delete-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .tabs {
      display: flex;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-top: 30px;
    }
    .tab-button {
      flex: 1;
      padding: 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    .tab-button.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
      background-color: rgba(99, 102, 241, 0.05);
    }
    .tab-button:hover:not(.active) {
      background-color: #f9fafb;
      color: var(--primary-dark);
    }
    .message-banner {
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      text-align: center;
      font-weight: bold;
    }
    .message-blue { background-color: #bfdbfe; color: #1e40af; }
    .message-green { background-color: #bbf7d0; color: #166534; }
    .message-red { background-color: #fecaca; color: #991b1b; }
    .modal-content button {
      padding: 10px 20px;
      margin-left: 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    #attribute-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 1001;
    }
    .user-block {
      position: absolute;
      top: 20px;
      right: 30px;
      text-align: right;
    }
    .user-block b {
      font-weight: bold;
    }
    .logout-btn {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 5px;
    }
    .recommendation-image {
      width: 80px;
      height: 80px;
      margin: 5px;
      border-radius: 8px;
      object-fit: cover;
    }
    #save-attributes { background-color: var(--primary); color: white; }
    #cancel-attributes { background-color: var(--danger); color: white; }
    .loader {
      display: none;
      border: 4px solid #e5e7eb;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <link rel="stylesheet" href="/static/css/shared-styles.css">
</head>
<body>
<header>
  <h1>WearPerfect</h1>
  <p>Smart Fashion Recommendations Based on Weather</p>
  <div class="user-block">
    Hi, <b>{{ username.capitalize() }}</b><br>
    <button class="logout-btn" onclick="logoutUser()">Logout</button>
  </div>
</header>

<div class="tabs">
  <button class="tab-button active" onclick="openTab('wardrobe')">üëï Online Wardrobe</button>
  <button class="tab-button" onclick="window.location.href='/recommendation'">üå§Ô∏è Instant Recommendation</button>
  <button class="tab-button" onclick="window.location.href='/chatbot'">üß≥ Tourist Chatbot</button>
</div>

<div class="upload-section">
  <h3>Add to Your Wardrobe</h3>
  <div class="upload-types">
    <button class="upload-type-btn active" onclick="setUploadType(this, 'top')">Top Wear</button>
    <button class="upload-type-btn" onclick="setUploadType(this, 'bottom')">Bottom Wear</button>
  </div>
  <input type="file" id="clothesUpload" accept="image/*" style="display:none;">
  <button class="upload-button" onclick="document.getElementById('clothesUpload').click()">Upload Clothes Image</button>
</div>

<div id="message-banner" class="message-banner" style="display:none;"></div>

<div id="attribute-modal" class="modal">
  <div class="modal-content">
    <h3>Verify Attributes</h3>
    <div id="attribute-form"></div>
    <div class="loader" id="save-loader"></div>
    <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
      <button id="save-attributes">Save</button>
      <button id="cancel-attributes">Cancel</button>
    </div>
  </div>
</div>

<div class="container">
  <h3>Your Wardrobe</h3>
  <div class="sub-tabs">
    <button class="sub-tab-button active" onclick="showSubTab('top')">Top Wear</button>
    <button class="sub-tab-button" onclick="showSubTab('bottom')">Bottom Wear</button>
  </div>
  <div id="top-wardrobe" class="wardrobe-grid"></div>
  <div id="bottom-wardrobe" class="wardrobe-grid" style="display:none;"></div>
</div>

<!-- Image Popup Modal -->
<div id="imageModal" class="image-modal">
  <span class="close-btn" id="closeModal">√ó</span>
  <img class="modal-content" id="modalImage">
</div>

<script>
  let selectedClothesType = 'top';
  const banner = document.getElementById('message-banner');

  document.getElementById('clothesUpload').addEventListener('change', e => {
    if (e.target.files[0]) uploadImageForAnalysis(e.target.files[0]);
  });

  function setUploadType(button, type) {
    document.querySelectorAll('.upload-type-btn').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    selectedClothesType = type;
  }

  async function uploadImageForAnalysis(file) {
    showMessage('Analyzing image...', 'blue');
    const formData = new FormData();
    formData.append('image', file);
    formData.append('type', selectedClothesType);
    try {
      const res = await fetch('http://127.0.0.1:5002/analyze_clothing', { method: 'POST', body: formData });
      const data = await res.json();
      if (!res.ok || data.error) {
        showMessage(data.error || 'Server error', 'red');
        return;
      }
      data.file = file;
      showAttributeVerificationModal(data, file);
      loadWardrobeItems();
    } catch (err) {
      showMessage('Server error: Could not analyze image.', 'red');
    }
  }

  async function deleteWardrobeItem(imageId) {
    try {
      const res = await fetch(`http://127.0.0.1:5002/delete_item/${imageId}`, { method: 'DELETE' });
      if (res.ok) {
        showMessage('Item deleted successfully!', 'green');
        loadWardrobeItems();
      } else {
        throw new Error('Delete failed');
      }
    } catch (err) {
      showMessage('Server error: Could not delete item.', 'red');
    }
  }

  function showAttributeVerificationModal(attributes, file) {
    const modal = document.getElementById('attribute-modal');
    const form = document.getElementById('attribute-form');
    form.innerHTML = '';

    ['primary_color_name', 'secondary_color_name'].forEach(colorKey => {
      const div = document.createElement('div');
      div.style.marginBottom = '10px';
      const label = document.createElement('label');
      label.textContent = colorKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) + ':';
      const input = document.createElement('input');
      input.type = 'text';
      input.id = colorKey;
      input.value = attributes[colorKey] || '';
      input.readOnly = true;
      input.style.width = '100%';
      input.style.padding = '8px';
      input.style.borderRadius = '4px';
      input.style.border = '1px solid #d1d5db';
      div.appendChild(label);
      div.appendChild(input);
      form.appendChild(div);
    });

    const commonDropdowns = {
      Fabric_Type: ['--Select--', 'Cotton', 'Chiffon', 'Knitted', 'Denim', 'Furry', 'Leather', 'Other'],
      Pattern_Type: ['--Select--', 'Pure Color', 'Graphic', 'Striped', 'Floral', 'Color-block', 'Lattice', 'Other'],
      clothing_type: ['top', 'bottom']
    };

    const topDropdowns = {
      sleeve_length: ['sleeveless', 'short-sleeve', 'medium-sleeve', 'long-sleeve'],
      neckline: ['round', 'V-shape', 'square', 'standing', 'lapel'],
      outer_cardigan: ['yes cardigan', 'no cardigan'],
      navel_covering: ['yes', 'no']
    };

    const bottomDropdowns = {
      lower_clothing_length: ['long', 'medium short', 'three-point', 'three-quarter']
    };

    const selectedDropdowns = selectedClothesType === 'top' ? topDropdowns : bottomDropdowns;

    for (const key in selectedDropdowns) {
      createSelectField(form, key, selectedDropdowns[key], attributes[key]);
    }
    for (const key in commonDropdowns) {
      const value = key === 'clothing_type' ? selectedClothesType : attributes[key];
      createSelectField(form, key, commonDropdowns[key], value);
    }

    document.getElementById('save-attributes').onclick = async () => {
      const updatedAttributes = {};
      form.querySelectorAll('select, input').forEach(field => {
        updatedAttributes[field.id] = field.value;
      });
      await saveAttributesToCsv(file, updatedAttributes, attributes.image_hash);
      modal.style.display = 'none';
    };
    document.getElementById('cancel-attributes').onclick = () => {
      modal.style.display = 'none';
    };
    modal.style.display = 'block';
  }

  function createSelectField(container, key, options, selectedValue) {
    const div = document.createElement('div');
    div.style.marginBottom = '10px';
    const label = document.createElement('label');
    label.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) + ':';
    const select = document.createElement('select');
    select.id = key;
    select.style.width = '100%';
    select.style.padding = '8px';
    select.style.borderRadius = '4px';
    select.style.border = '1px solid #d1d5db';
    options.forEach(val => {
      const option = document.createElement('option');
      option.value = val;
      option.textContent = val;
      if ((selectedValue || '').toLowerCase() === val.toLowerCase() || (val === '--Select--' && !selectedValue)) option.selected = true;
      select.appendChild(option);
    });
    div.appendChild(label);
    div.appendChild(select);
    container.appendChild(div);
  }

  async function saveAttributesToCsv(file, attributes, imageHash) {
    const loader = document.getElementById('save-loader');
    const saveButton = document.getElementById('save-attributes');
    try {
      loader.style.display = 'block';
      saveButton.disabled = true;
      const response = await fetch('http://127.0.0.1:5002/save_attributes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image_id: file.name, clothing_type: selectedClothesType, image_hash: imageHash, attributes })
      });
      if (!response.ok) {
        throw new Error('Failed to save attributes');
      }
      showMessage('Attributes saved successfully!', 'green');
      loadWardrobeItems();
    } catch (err) {
      showMessage('Server error: Could not save attributes.', 'red');
    } finally {
      loader.style.display = 'none';
      saveButton.disabled = false;
    }
  }

  function addNewClothingToWardrobe(file, attributes) {
    const grid = document.querySelector('.wardrobe-grid');
    const item = document.createElement('div');
    item.className = 'clothes-item';
    const imgURL = URL.createObjectURL(file);
    item.innerHTML = `<img src="${imgURL}" class="recommendation-image" alt="${file.name}">
      <div style="padding:10px;"><h4>${file.name}</h4><p>${selectedClothesType}</p></div>`;
    grid.prepend(item);
  }

  async function loadWardrobeItems() {
    const res = await fetch('http://127.0.0.1:5002/get_wardrobe_items');
    const items = await res.json();
    const topGrid = document.getElementById('top-wardrobe');
    const bottomGrid = document.getElementById('bottom-wardrobe');
    topGrid.innerHTML = '';
    bottomGrid.innerHTML = '';

    let topCount = 0;
    let bottomCount = 0;

    items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'clothes-item';
      div.innerHTML = `<img src="${item.image_url}" alt="${item.display_name}" class="recommendation-image">
        <button class="delete-button" onclick="deleteWardrobeItem('${item.image_id}')">Delete</button>
        <div style="padding:10px;"><h4>${item.display_name}</h4><p>${item.clothing_type}</p></div>`;

      if (item.clothing_type === 'top') {
        topGrid.appendChild(div);
        topCount++;
      } else if (item.clothing_type === 'bottom') {
        bottomGrid.appendChild(div);
        bottomCount++;
      }
    });
    if (topCount === 0) {
      topGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #d97706; font-weight: bold;">‚ö†Ô∏è No top wear images found in wardrobe. Please upload clothing images to get recommendations...</div>';
    }
    if (bottomCount === 0) {
      bottomGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #d97706; font-weight: bold;">‚ö†Ô∏è No bottom wear images found in wardrobe. Please upload clothing images to get recommendations...</div>';
    }
  }

  function showSubTab(type) {
    document.getElementById('top-wardrobe').style.display = (type === 'top') ? 'grid' : 'none';
    document.getElementById('bottom-wardrobe').style.display = (type === 'bottom') ? 'grid' : 'none';
    document.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.sub-tab-button[onclick*='${type}']`).classList.add('active');
  }

  function showMessage(msg, type) {
    banner.textContent = msg;
    banner.className = `message-banner message-${type}`;
    banner.style.display = 'block';
    setTimeout(() => { banner.style.display = 'none'; }, 4000);
  }

  async function logoutUser() {
    const res = await fetch('/logout', { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      alert('Logged out successfully.');
      window.location.href = '/';
    } else {
      alert(`Logout failed: ${data.error}`);
    }
  }

  window.addEventListener('DOMContentLoaded', loadWardrobeItems);

  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const closeBtn = document.getElementById('closeModal');

    document.body.addEventListener('click', function(e) {
      if (e.target.classList.contains('recommendation-image')) {
        modal.style.display = 'block';
        modalImg.src = e.target.src;
      }
    });

    closeBtn.onclick = function() {
      modal.style.display = 'none';
    };

    window.onclick = function(event) {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    };
  });
</script>
</body>
</html>